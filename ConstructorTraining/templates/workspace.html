{% extends 'base.html' %}

{% block content %}
    {% load static %}
    {% if user.is_authenticated %}
<div class="header">
        <a class="user" href="#">{{user.username}}</a>
        <a class="logout" href="{% url 'logout' %}">Выйти</a>
    <div class="name_traning">
        <form action="/mytrainings/" class="button_home">
        <button type="submit">Вернуться назад</button>
         </form>
        <h1 class="constructortitle">Название тренинга:  {{training.title}}</h1>

    </div>



    <div class="right_buttom">
        <img class="pict_bttom" src="{% static '/images/SVGRepo_iconCarrier.svg'%}" alt="" width="80px" height="70px">
        <div class="new_object" style="display: none;">
            <div class="resize-handle"></div>
        </div>
    </div>
    <button onclick="saveObject()">Сохранить объект</button>



<script>
document.addEventListener('DOMContentLoaded', function () {
    var rightButton = document.querySelector('.right_buttom');
    if (rightButton) {
        rightButton.addEventListener('click', function () {
            enableDrawing(); // Запускаем режим создания объекта при нажатии на кнопку
        });
    }
});

function enableDrawing() {
    var startX, startY, currentX, currentY;
    var drawingObject;

    document.onmousedown = startDrawing;
    document.onmousemove = drawObject;
    document.onmouseup = stopDrawing;

    function startDrawing(e) {
        startX = e.clientX;
        startY = e.clientY;
        drawingObject = document.createElement('div');
        drawingObject.className = 'new_object';
        drawingObject.style.position = 'absolute';
        drawingObject.style.left = startX + 'px';
        drawingObject.style.top = startY + 'px';
        document.body.appendChild(drawingObject);
    }

    function drawObject(e) {
        if (!drawingObject) return;
        currentX = e.clientX;
        currentY = e.clientY;
        var width = currentX - startX;
        var height = currentY - startY;
        drawingObject.style.width = Math.abs(width) + 'px';
        drawingObject.style.height = Math.abs(height) + 'px';
        drawingObject.style.left = (width > 0) ? startX + 'px' : (startX + width) + 'px';
        drawingObject.style.top = (height > 0) ? startY + 'px' : (startY + height) + 'px';
    }

    function stopDrawing() {
        document.onmousedown = null;
        document.onmousemove = null;
        document.onmouseup = null;
    }
}

document.addEventListener('DOMContentLoaded', function () {
        var resizeHandle = document.querySelector('.resize-handle');
        var elementBeingResized;

        function initResize(e) {
            // Предотвращаем всплывающие события
            e.preventDefault();
            e.stopPropagation();
            elementBeingResized = resizeHandle.parentNode;
            window.addEventListener('mousemove', startResizing, false);
            window.addEventListener('mouseup', stopResizing, false);
        }

        function startResizing(e) {
            if (!elementBeingResized) return;

            // Рассчитываем новые размеры, основываясь на позиции курсора
            const minWidth = 10; // Минимальная ширина
            const minHeight = 10; // Минимальная высота
            const newWidth = Math.max(e.clientX - elementBeingResized.offsetLeft, minWidth);
            const newHeight = Math.max(e.clientY - elementBeingResized.offsetTop, minHeight);

            // Применяем размеры к элементу
            elementBeingResized.style.width = `${newWidth}px`;
            elementBeingResized.style.height = `${newHeight}px`;
        }

        function stopResizing() {
            // Сохраняем размеры после изменения размера
            localStorage.setItem('resizedElementWidth', elementBeingResized.style.width);
            localStorage.setItem('resizedElementHeight', elementBeingResized.style.height);

            // Удаляем обработчики событий
            window.removeEventListener('mousemove', startResizing, false);
            window.removeEventListener('mouseup', stopResizing, false);
            elementBeingResized = null;
        }

        resizeHandle.addEventListener('mousedown', initResize, false);
    });

    function getCsrfToken() {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                return cookie.substring('csrftoken='.length, cookie.length);
            }
        }
        return '';
    }

    function saveObject() {
    var element = document.querySelector('.new_object');
    var objectId = element.getAttribute('data-id'); // Получаем текущий ID объекта

    // Use getBoundingClientRect to get accurate dimensions and position
    var rect = element.getBoundingClientRect();

    var xhr = new XMLHttpRequest();
    xhr.open('POST', '/save_coordinates/', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', getCsrfToken());

    // Prepare data with getBoundingClientRect values
    var data = {
        object_id: objectId,
        top: rect.top + 'px',
        left: rect.left + 'px',
        width: rect.width + 'px',
        height: rect.height + 'px'
    };

    xhr.onreadystatechange = function() {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            var response = JSON.parse(xhr.responseText);
            if (xhr.status === 200) {
                element.setAttribute('data-id', response.object_id);
                alert("Координаты сохранены: " + JSON.stringify(response));
            } else {
                alert("Ошибка сохранения: " + response.error);
            }
        }
    };

    xhr.send(JSON.stringify(data));
}
    </script>


    <div class="left_buttom">
        <img class="pict_bttom" src="{% static '/images/left.svg'%}"  alt="" width="80px" height="70px">
    </div>

    <div class="double_buttom">
        <img class="pict_bttom" src="{% static '/images/double.svg'%}"  alt="" width="80px" height="70px">
    </div>

    <div class="finger_buttom">
        <img class="pict_bttom" src="{% static '/images/finger.svg'%}"  alt="" width="80px" height="70px">
    </div>

    <div class="keyboard_buttom">
        <img class="pict_bttom" src="{% static '/images/keyboard.svg'%}"  alt="" width="80px" height="70px">
    </div>

    <div class="text_buttom">
        <img class="pict_bttom" src="{% static '/images/text.svg'%}"  alt="" width="80px" height="70px">
    </div>

    <button id="myBtn">Обучение</button>

    <div id="myModaxl" class="modalx">
        <div class="modal-contentx">
            <span class="closex">×</span>
            <h1 class="Title_training">Обучение (также появятся картинки)</h1>
            <p>Слева имеются кнопки (выборы режима тригера)</p>
            <p>Перед началом работы необходимо выбрать какой-либо инструмент. После нажатия на соответствующий инструмент
            достаточно ЛКМ выделить область, которая необходима. Далее нажать на кнопку "Подтвердить".
            </p>
        </div>
    </div>

    <script>
        var modalx = document.getElementById('myModaxl');
        var btn = document.getElementById("myBtn");
        var span = document.getElementsByClassName("closex")[0];

        btn.onclick = function() {
            modalx.style.display = "block";
        }

        span.onclick = function() {
            modalx.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modalx) {
                modalx.style.display = "none";
            }
        }
    </script>




{% endif %}

{% endblock %}
